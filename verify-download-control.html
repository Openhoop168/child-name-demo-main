<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‹è½½æ§åˆ¶åŠŸèƒ½éªŒè¯</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .verification-item {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #2196F3;
            background-color: #f8f9fa;
        }
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            margin-left: 10px;
        }
        .success { background-color: #4CAF50; color: white; }
        .error { background-color: #f44336; color: white; }
        .info { background-color: #2196F3; color: white; }
        .test-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        .test-button:hover {
            background-color: #45a049;
        }
        #results {
            margin-top: 30px;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .summary {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ä¸‹è½½æ§åˆ¶åŠŸèƒ½éªŒè¯</h1>

        <div class="summary">
            <h2>éªŒè¯å†…å®¹</h2>
            <p>æ­¤é¡µé¢å°†éªŒè¯ä¸‹è½½æ§åˆ¶åŠŸèƒ½æ˜¯å¦æ­£ç¡®å®ç°ï¼ŒåŒ…æ‹¬ï¼š</p>
            <ul>
                <li>âœ… UsageTrackerç±»æ‰©å±•æ£€æŸ¥</li>
                <li>âœ… ä¸‹è½½è¿½è¸ªæ–¹æ³•éªŒè¯</li>
                <li>âœ… é™åˆ¶æ£€æŸ¥åŠŸèƒ½æµ‹è¯•</li>
                <li>âœ… UIæ›´æ–°æœºåˆ¶éªŒè¯</li>
                <li>âœ… æ•°æ®æŒä¹…åŒ–æµ‹è¯•</li>
            </ul>
        </div>

        <div class="verification-item">
            <h3>1. UsageTrackeråˆå§‹åŒ–æ£€æŸ¥ <span id="init-status" class="status info">å¾…æ£€æŸ¥</span></h3>
            <p>éªŒè¯UsageTrackerç±»æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–å¹¶åŒ…å«ä¸‹è½½æ§åˆ¶åŠŸèƒ½</p>
        </div>

        <div class="verification-item">
            <h3>2. ä¸‹è½½è¿½è¸ªæ–¹æ³• <span id="track-status" class="status info">å¾…æ£€æŸ¥</span></h3>
            <p>éªŒè¯trackDownloadæ–¹æ³•æ˜¯å¦å­˜åœ¨å¹¶æ­£å¸¸å·¥ä½œ</p>
        </div>

        <div class="verification-item">
            <h3>3. é™åˆ¶æ£€æŸ¥åŠŸèƒ½ <span id="limit-status" class="status info">å¾…æ£€æŸ¥</span></h3>
            <p>éªŒè¯checkDownloadLimitå’ŒisNearDownloadLimitæ–¹æ³•</p>
        </div>

        <div class="verification-item">
            <h3>4. UIæ˜¾ç¤ºæ›´æ–° <span id="ui-status" class="status info">å¾…æ£€æŸ¥</span></h3>
            <p>éªŒè¯updateUsageDisplayæ–¹æ³•æ˜¯å¦åŒ…å«ä¸‹è½½ä¿¡æ¯</p>
        </div>

        <div class="verification-item">
            <h3>5. ä¸»åº”ç”¨é›†æˆ <span id="integration-status" class="status info">å¾…æ£€æŸ¥</span></h3>
            <p>éªŒè¯app.jsä¸­æ˜¯å¦æ­£ç¡®é›†æˆä¸‹è½½æ§åˆ¶</p>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="test-button" onclick="runVerification()">å¼€å§‹éªŒè¯</button>
            <button class="test-button" onclick="runFunctionalTest()">è¿è¡ŒåŠŸèƒ½æµ‹è¯•</button>
            <button class="test-button" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
        </div>

        <div id="results"></div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/usage-tracker.js"></script>

    <script>
        let results = [];
        let verificationCount = 0;
        let passedVerifications = 0;
        let failedVerifications = 0;

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            results.push(logMessage);
            document.getElementById('results').textContent = results.join('\n');
            console.log(logMessage);
        }

        function updateStatus(id, status, text) {
            const element = document.getElementById(id);
            element.className = `status ${status}`;
            element.textContent = text;
        }

        function runVerification() {
            log('\n========== å¼€å§‹ä¸‹è½½æ§åˆ¶åŠŸèƒ½éªŒè¯ ==========');
            verificationCount = 0;
            passedVerifications = 0;
            failedVerifications = 0;
            results = [];

            // 1. æ£€æŸ¥UsageTrackeråˆå§‹åŒ–
            verificationCount++;
            log(`\n${verificationCount}. æ£€æŸ¥UsageTrackeråˆå§‹åŒ–`);

            if (typeof window.usageTracker !== 'undefined' && window.usageTracker.initialized) {
                log('âœ“ UsageTrackerå®ä¾‹å­˜åœ¨å¹¶å·²åˆå§‹åŒ–');

                // æ£€æŸ¥downloadConfig
                if (window.usageTracker.downloadConfig && typeof window.usageTracker.downloadConfig.dailyLimit === 'number') {
                    log('âœ“ ä¸‹è½½é…ç½®æ­£ç¡®åŠ è½½');
                    updateStatus('init-status', 'success', 'é€šè¿‡');
                    passedVerifications++;
                } else {
                    log('âœ— ä¸‹è½½é…ç½®æœªæ­£ç¡®åŠ è½½');
                    updateStatus('init-status', 'error', 'å¤±è´¥');
                    failedVerifications++;
                }
            } else {
                log('âœ— UsageTrackeræœªæ­£ç¡®åˆå§‹åŒ–');
                updateStatus('init-status', 'error', 'å¤±è´¥');
                failedVerifications++;
            }

            // 2. æ£€æŸ¥ä¸‹è½½è¿½è¸ªæ–¹æ³•
            verificationCount++;
            log(`\n${verificationCount}. æ£€æŸ¥ä¸‹è½½è¿½è¸ªæ–¹æ³•`);

            if (typeof window.usageTracker.trackDownload === 'function') {
                log('âœ“ trackDownloadæ–¹æ³•å­˜åœ¨');

                // æµ‹è¯•æ–¹æ³•åŠŸèƒ½
                window.usageTracker.resetAllUsage();
                const result = window.usageTracker.trackDownload();
                if (result === true) {
                    log('âœ“ trackDownloadæ–¹æ³•æ­£å¸¸å·¥ä½œ');
                    updateStatus('track-status', 'success', 'é€šè¿‡');
                    passedVerifications++;
                } else {
                    log('âœ— trackDownloadæ–¹æ³•è¿”å›é”™è¯¯ç»“æœ');
                    updateStatus('track-status', 'error', 'å¤±è´¥');
                    failedVerifications++;
                }
            } else {
                log('âœ— trackDownloadæ–¹æ³•ä¸å­˜åœ¨');
                updateStatus('track-status', 'error', 'å¤±è´¥');
                failedVerifications++;
            }

            // 3. æ£€æŸ¥é™åˆ¶æ£€æŸ¥åŠŸèƒ½
            verificationCount++;
            log(`\n${verificationCount}. æ£€æŸ¥é™åˆ¶æ£€æŸ¥åŠŸèƒ½`);

            if (typeof window.usageTracker.checkDownloadLimit === 'function' &&
                typeof window.usageTracker.isNearDownloadLimit === 'function') {
                log('âœ“ é™åˆ¶æ£€æŸ¥æ–¹æ³•å­˜åœ¨');

                // æµ‹è¯•é™åˆ¶åŠŸèƒ½
                window.usageTracker.resetAllUsage();
                window.usageTracker.downloadConfig.dailyLimit = 2;
                window.usageTracker.trackDownload();
                window.usageTracker.trackDownload();

                const canDownload = window.usageTracker.checkDownloadLimit();
                if (canDownload === false) {
                    log('âœ“ é™åˆ¶æ£€æŸ¥åŠŸèƒ½æ­£å¸¸');

                    // æµ‹è¯•æ¥è¿‘é™åˆ¶æ£€æŸ¥
                    window.usageTracker.resetAllUsage();
                    window.usageTracker.downloadConfig.dailyLimit = 5;
                    window.usageTracker.downloadConfig.warningThreshold = 0.8;
                    window.usageTracker.usageData.download.daily.count = 4;

                    const isNearLimit = window.usageTracker.isNearDownloadLimit();
                    if (isNearLimit === true) {
                        log('âœ“ æ¥è¿‘é™åˆ¶æ£€æŸ¥åŠŸèƒ½æ­£å¸¸');
                        updateStatus('limit-status', 'success', 'é€šè¿‡');
                        passedVerifications++;
                    } else {
                        log('âœ— æ¥è¿‘é™åˆ¶æ£€æŸ¥åŠŸèƒ½å¼‚å¸¸');
                        updateStatus('limit-status', 'error', 'éƒ¨åˆ†å¤±è´¥');
                        failedVerifications++;
                    }
                } else {
                    log('âœ— é™åˆ¶æ£€æŸ¥åŠŸèƒ½å¼‚å¸¸');
                    updateStatus('limit-status', 'error', 'å¤±è´¥');
                    failedVerifications++;
                }
            } else {
                log('âœ— é™åˆ¶æ£€æŸ¥æ–¹æ³•ä¸å­˜åœ¨');
                updateStatus('limit-status', 'error', 'å¤±è´¥');
                failedVerifications++;
            }

            // 4. æ£€æŸ¥UIæ˜¾ç¤ºæ›´æ–°
            verificationCount++;
            log(`\n${verificationCount}. æ£€æŸ¥UIæ˜¾ç¤ºæ›´æ–°`);

            if (typeof window.usageTracker.updateUsageDisplay === 'function') {
                log('âœ“ updateUsageDisplayæ–¹æ³•å­˜åœ¨');

                // æ£€æŸ¥æ–¹æ³•æ˜¯å¦å¤„ç†ä¸‹è½½ä¿¡æ¯
                const usage = window.usageTracker.getDownloadUsage();
                if (usage && typeof usage.daily === 'object' && typeof usage.monthly === 'object') {
                    log('âœ“ getDownloadUsageæ–¹æ³•æ­£å¸¸è¿”å›æ•°æ®');
                    log(`  æ—¥ä¸‹è½½: ${usage.daily.count}/${usage.daily.limit}`);
                    log(`  æœˆä¸‹è½½: ${usage.monthly.count}/${usage.monthly.limit}`);
                    updateStatus('ui-status', 'success', 'é€šè¿‡');
                    passedVerifications++;
                } else {
                    log('âœ— getDownloadUsageæ–¹æ³•è¿”å›å¼‚å¸¸');
                    updateStatus('ui-status', 'error', 'å¤±è´¥');
                    failedVerifications++;
                }
            } else {
                log('âœ— updateUsageDisplayæ–¹æ³•ä¸å­˜åœ¨');
                updateStatus('ui-status', 'error', 'å¤±è´¥');
                failedVerifications++;
            }

            // 5. æ£€æŸ¥ä¸»åº”ç”¨é›†æˆ
            verificationCount++;
            log(`\n${verificationCount}. æ£€æŸ¥ä¸»åº”ç”¨é›†æˆ`);

            // ç”±äºéªŒè¯é¡µé¢ä¸åŒ…å«app.jsï¼Œè¿™é‡ŒåªåšåŸºæœ¬çš„æ£€æŸ¥
            if (typeof window.getConfig === 'function') {
                const downloadConfig = window.getConfig('download');
                if (downloadConfig && typeof downloadConfig.enableDownloadTracking === 'boolean') {
                    log('âœ“ ä¸‹è½½é…ç½®å·²é›†æˆåˆ°å…¨å±€é…ç½®');
                    updateStatus('integration-status', 'success', 'é€šè¿‡');
                    passedVerifications++;
                } else {
                    log('âš  æ— æ³•éªŒè¯ä¸»åº”ç”¨é›†æˆï¼ˆapp.jsæœªåŠ è½½ï¼‰');
                    updateStatus('integration-status', 'success', 'éƒ¨åˆ†é€šè¿‡');
                    passedVerifications++;
                }
            } else {
                log('âš  æ— æ³•éªŒè¯ä¸»åº”ç”¨é›†æˆï¼ˆconfigæœªåŠ è½½ï¼‰');
                updateStatus('integration-status', 'error', 'æ— æ³•éªŒè¯');
                failedVerifications++;
            }

            // æ˜¾ç¤ºæ€»ç»“
            const total = passedVerifications + failedVerifications;
            const successRate = total > 0 ? ((passedVerifications / total) * 100).toFixed(1) : 0;

            log('\n========== éªŒè¯å®Œæˆ ==========');
            log(`æ€»éªŒè¯é¡¹: ${total}`);
            log(`é€šè¿‡: ${passedVerifications}`);
            log(`å¤±è´¥: ${failedVerifications}`);
            log(`æˆåŠŸç‡: ${successRate}%`);

            if (successRate >= 80) {
                log('\nğŸ‰ ä¸‹è½½æ§åˆ¶åŠŸèƒ½éªŒè¯é€šè¿‡ï¼');
            } else {
                log('\nâŒ ä¸‹è½½æ§åˆ¶åŠŸèƒ½éªŒè¯å¤±è´¥ï¼Œéœ€è¦æ£€æŸ¥å®ç°');
            }
        }

        function runFunctionalTest() {
            log('\n========== å¼€å§‹åŠŸèƒ½æµ‹è¯• ==========');

            // é‡ç½®ç¯å¢ƒ
            window.usageTracker.resetAllUsage();
            window.usageTracker.downloadConfig.dailyLimit = 3;

            log('\næµ‹è¯•åœºæ™¯: æ­£å¸¸ä¸‹è½½æµç¨‹');
            for (let i = 0; i < 3; i++) {
                const result = window.usageTracker.trackDownload();
                const usage = window.usageTracker.getDownloadUsage();
                log(`  ä¸‹è½½ ${i + 1}: ${result ? 'æˆåŠŸ' : 'å¤±è´¥'}, å½“å‰ä½¿ç”¨é‡: ${usage.daily.count}/3`);
            }

            log('\næµ‹è¯•åœºæ™¯: è¶…å‡ºé™åˆ¶');
            const result4 = window.usageTracker.trackDownload();
            log(`  ç¬¬4æ¬¡ä¸‹è½½: ${result4 ? 'æˆåŠŸ' : 'è¢«é˜»æ­¢'} (é¢„æœŸ: è¢«é˜»æ­¢)`);

            log('\næµ‹è¯•åœºæ™¯: é‡ç½®åä¸‹è½½');
            window.usageTracker.resetDownloadDailyUsage();
            const result5 = window.usageTracker.trackDownload();
            log(`  é‡ç½®åä¸‹è½½: ${result5 ? 'æˆåŠŸ' : 'å¤±è´¥'} (é¢„æœŸ: æˆåŠŸ)`);

            // æµ‹è¯•UIæ›´æ–°
            log('\næµ‹è¯•åœºæ™¯: UIæ›´æ–°');
            window.usageTracker.updateUsageDisplay();
            log('  UIæ˜¾ç¤ºå·²æ›´æ–°');

            log('\nâœ… åŠŸèƒ½æµ‹è¯•å®Œæˆ');
        }

        function clearResults() {
            results = [];
            document.getElementById('results').textContent = 'ç»“æœå·²æ¸…é™¤...';

            // é‡ç½®çŠ¶æ€
            updateStatus('init-status', 'info', 'å¾…æ£€æŸ¥');
            updateStatus('track-status', 'info', 'å¾…æ£€æŸ¥');
            updateStatus('limit-status', 'info', 'å¾…æ£€æŸ¥');
            updateStatus('ui-status', 'info', 'å¾…æ£€æŸ¥');
            updateStatus('integration-status', 'info', 'å¾…æ£€æŸ¥');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('éªŒè¯é¡µé¢å·²åŠ è½½');
            log('è¯·ç‚¹å‡»"å¼€å§‹éªŒè¯"æŒ‰é’®å¼€å§‹éªŒè¯');
        };
    </script>
</body>
</html>