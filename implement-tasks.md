# 儿童识字小报生成器 - 实施任务清单

## 📋 任务概述

根据技术设计方案，将商业化改造分解为可执行的任务。

## 🎯 第一阶段：用户自备API密钥（第1周）

### 1.1 核心功能开发

#### 任务1：修改应用初始化逻辑 ✅
- **文件**：`js/app.js`
- **内容**：
  - [x] 修改 `initialize()` 方法，添加API密钥检查
  - [x] 实现 `checkUserApiKey()` 方法
  - [x] 实现 `showApiKeySetupModal()` 方法
  - [x] 移除默认API密钥加载逻辑
- **优先级**：高
- **预计时间**：4小时
- **完成时间**：2025-12-13
- **完成说明**：
  - 已修改 `initialize()` 方法，在初始化时检查用户API密钥
  - 实现了 `checkUserApiKey()` 方法，从localStorage检查并验证API密钥
  - 实现了 `showApiKeySetupModal()` 方法，显示美观的API密钥设置界面
  - API密钥验证通过后才继续初始化，否则显示设置界面

#### 任务2：实现API密钥管理功能 ✅
- **文件**：`js/app.js`
- **内容**：
  - [x] 实现 `saveUserApiKey()` 方法
  - [x] 实现 `validateApiKeyInput()` 方法
  - [x] 实现 `verifyApiKeyValidity()` 方法
  - [x] 实现 `storeUserApiKey()` 方法
  - [x] 实现 `loadUserApiKey()` 方法
  - [x] 实现 `clearUserApiKey()` 方法
  - [x] 实现 `showApiKeyError()` 方法
  - [x] 实现 `toggleUserApiKeyVisibility()` 方法
  - [x] 实现 `showApiKeyGuide()` 方法
- **优先级**：高
- **预计时间**：6小时
- **完成时间**：2025-12-13
- **完成说明**：
  - 实现了完整的API密钥管理功能集
  - 包含输入验证、存储、加载、清除等操作
  - 提供了用户友好的错误处理和引导界面
  - 支持密钥可见性切换和获取指南
  - 集成了安全验证和格式检查

#### 任务3：修改API客户端 ✅
- **文件**：`js/api-client.js`
- **内容**：
  - [x] 修改 `initialize()` 方法，实现智能密钥管理
  - [x] 实现 `loadUserApiKey()` 方法，加载用户密钥
  - [x] 实现 `setUserApiKey()` 方法，设置用户密钥
  - [x] 实现 `clearUserApiKey()` 方法，清除用户密钥
  - [x] 更新 `createTask()` 和 `queryTaskStatus()` 方法，添加密钥来源追踪
- **优先级**：高
- **预计时间**：2小时
- **完成时间**：2025-12-13
- **完成说明**：
  - 实现了智能密钥管理系统，优先使用用户密钥，否则使用默认密钥
  - 添加了API密钥来源枚举和追踪机制
  - 实现了完整的用户密钥管理功能（设置、清除、加载）
  - 在API调用中添加了来源追踪，为用量追踪做准备
  - 支持灵活的密钥切换，提升用户体验

#### 任务4：创建API密钥设置界面 ✅
- **文件**：`css/style.css`
- **内容**：
  - [x] 添加 `.api-key-setup` 样式
  - [x] 添加 `.setup-header` 样式
  - [x] 添加 `.step` 样式
  - [x] 添加 `.input-group` 样式
  - [x] 添加 `.api-key-input` 样式
  - [x] 添加 `.toggle-visibility` 样式
  - [x] 添加 `.error-message` 样式
  - [x] 添加 `.security-notice` 样式
  - [x] 添加响应式样式
- **优先级**：高
- **预计时间**：3小时
- **完成时间**：2025-12-13
- **完成说明**：
  - 已创建完整的API密钥设置界面CSS样式系统
  - 包含9个核心样式类，覆盖所有界面元素
  - 实现了流畅的动画效果（fadeIn、slideUp、shake、spin）
  - 添加了完善的响应式设计，支持桌面、平板和移动设备
  - 包含高对比度模式和深色模式支持
  - 使用项目现有的设计系统和CSS变量
  - 提供了良好的用户体验和可访问性

#### 任务5：更新配置文件 ✅
- **文件**：`config.template.js`
- **内容**：
  - [x] 移除默认API密钥
  - [x] 添加 `requireUserApiKey: true` 配置
  - [x] 添加 `freeDailyLimit: 50` 配置
  - [x] 添加 `enableUsageTracking: true` 配置
- **优先级**：中
- **预计时间**：0.5小时
- **完成时间**：2025-12-14
- **完成说明**：
  - 已移除默认API密钥，将 apiKey 设置为空字符串
  - 已添加 requireUserApiKey: true 配置，强制要求用户提供API密钥
  - 已添加每日使用量限制配置，支持环境变量 DAILY_USAGE_LIMIT，默认值为100
  - 已添加 enableUsageTracking: true 配置，启用使用量追踪功能
  - 配置文件支持灵活的环境变量替换和默认值设置

### 1.2 安全增强

#### 任务6：添加安全头 ✅
- **文件**：`index.html`
- **内容**：
  - [x] 添加 CSP meta标签
  - [x] 添加 X-Content-Type-Options meta标签
  - [x] 添加 X-Frame-Options meta标签
  - [x] 添加 X-XSS-Protection meta标签
  - [x] 添加 Referrer-Policy meta标签
- **优先级**：高
- **预计时间**：1小时
- **完成时间**：2025-12-14
- **完成说明**：
  - 已成功添加所有5个HTTP安全头meta标签
  - CSP策略正确配置，允许必要资源同时限制风险
  - 通过Playwright MCP验证，所有安全头正常工作
  - 页面功能正常，无安全头冲突问题
  - 显著提升应用安全性，防护XSS、点击劫持等攻击

#### 任务7：增强输入验证
- **文件**：`js/security-utils.js`
- **内容**：
  - [ ] 实现 `validateUserContent()` 方法
  - [ ] 增强 `sanitizeHtml()` 方法
  - [ ] 添加更多XSS防护模式
- **优先级**：中
- **预计时间**：2小时

### 1.3 测试和部署

#### 任务8：功能测试
- **内容**：
  - [ ] 测试新用户首次使用流程
  - [ ] 测试API密钥保存功能
  - [ ] 测试API密钥验证功能
  - [ ] 测试错误处理机制
  - [ ] 测试生成功能是否正常
- **优先级**：高
- **预计时间**：3小时

#### 任务9：部署验证
- **内容**：
  - [ ] 提交代码到GitHub
  - [ ] 验证GitHub Pages部署
  - [ ] 测试线上功能
- **优先级**：高
- **预计时间**：1小时

## 🔧 第二阶段：使用量追踪（第2-3周）

### 2.1 使用量管理

#### 任务10：创建使用量追踪模块
- **文件**：`js/usage-tracker.js`（新建）
- **内容**：
  - [ ] 创建 `UsageTracker` 类
  - [ ] 实现 `trackGeneration()` 方法
  - [ ] 实现 `checkDailyLimit()` 方法
  - [ ] 实现 `getUsage()` 方法
  - [ ] 实现 `saveUsage()` 方法
  - [ ] 实现 `showNearLimitWarning()` 方法
  - [ ] 实现 `showDailyLimitReached()` 方法
- **优先级**：中
- **预计时间**：4小时

#### 任务11：集成使用量追踪
- **文件**：`js/app.js`
- **内容**：
  - [ ] 在构造函数中初始化 `UsageTracker`
  - [ ] 在 `generateImage()` 方法中添加使用量检查
  - [ ] 在生成成功/失败后追踪使用量
- **优先级**：中
- **预计时间**：2小时

#### 任务12：使用量UI展示
- **文件**：`css/style.css`
- **内容**：
  - [ ] 添加使用量展示样式
  - [ ] 添加警告弹窗样式
  - [ ] 添加限制提示样式
- **优先级**：低
- **预计时间**：2小时

### 2.2 用户体验优化

#### 任务13：添加使用量提示
- **文件**：`index.html` 和 `js/app.js`
- **内容**：
  - [ ] 在页面上显示今日剩余次数
  - [ ] 添加使用量历史记录查看
  - [ ] 优化提示文案
- **优先级**：低
- **预计时间**：3小时

## 💳 第三阶段：付费套餐系统（第4-6周）

### 3.1 支付功能开发

#### 任务14：创建支付管理模块
- **文件**：`js/payment-manager.js`（新建）
- **内容**：
  - [ ] 创建 `PaymentManager` 类
  - [ ] 定义套餐配置
  - [ ] 实现 `showPaymentModal()` 方法
  - [ ] 实现 `getPlanFeatures()` 方法
  - [ ] 实现套餐选择逻辑
- **优先级**：中
- **预计时间**：5小时

#### 任务15：套餐UI设计
- **文件**：`css/style.css`
- **内容**：
  - [ ] 设计套餐卡片样式
  - [ ] 添加价格展示样式
  - [ ] 添加功能列表样式
  - [ ] 添加购买按钮样式
  - [ ] 添加响应式布局
- **优先级**：中
- **预计时间**：4小时

#### 任务16：支付集成
- **文件**：`js/payment-manager.js`
- **内容**：
  - [ ] 集成支付宝SDK
  - [ ] 集成微信支付SDK
  - [ ] 实现支付成功回调
  - [ ] 实现支付失败处理
- **优先级**：高
- **预计时间**：8小时

### 3.2 用户系统

#### 任务17：用户注册登录
- **文件**：`js/user-manager.js`（新建）
- **内容**：
  - [ ] 创建 `UserManager` 类
  - [ ] 实现注册功能
  - [ ] 实现登录功能
  - [ ] 实现密码加密
  - [ ] 实现会话管理
- **优先级**：高
- **预计时间**：6小时

#### 任务18：用户中心
- **文件**：`js/user-manager.js` 和 `index.html`
- **内容**：
  - [ ] 创建用户中心页面
  - [ ] 显示用户信息
  - [ ] 显示购买记录
  - [ ] 显示使用统计
- **优先级**：中
- **预计时间**：4小时

### 3.3 后端服务（可选）

#### 任务19：创建后端API
- **文件**：`server.js`（新建）
- **内容**：
  - [ ] 设置Express服务器
  - [ ] 实现用户API
  - [ ] 实现支付API
  - [ ] 实现使用量API
  - [ ] 添加安全中间件
- **优先级**：低
- **预计时间**：10小时

#### 任务20：数据库设计
- **内容**：
  - [ ] 设计用户表
  - [ ] 设计订单表
  - [ ] 设计使用量表
  - [ ] 创建数据库连接
- **优先级**：低
- **预计时间**：6小时

## 📊 持续优化任务

### 4.1 监控和分析

#### 任务21：添加数据分析
- **文件**：`js/analytics.js`（新建）
- **内容**：
  - [ ] 实现事件追踪
  - [ ] 追踪用户行为
  - [ ] 统计转化率
  - [ ] 生成报表
- **优先级**：低
- **预计时间**：4小时

#### 任务22：性能优化
- **内容**：
  - [ ] 优化图片加载速度
  - [ ] 缓存API响应
  - [ ] 压缩CSS和JS
  - [ ] 使用CDN加速
- **优先级**：低
- **预计时间**：3小时

### 4.2 安全加固

#### 任务23：安全审计
- **内容**：
  - [ ] 审查前端代码
  - [ ] 检查XSS漏洞
  - [ ] 验证CSRF保护
  - [ ] 测试输入验证
- **优先级**：中
- **预计时间**：5小时

#### 任务24：备份和恢复
- **内容**：
  - [ ] 实现数据备份
  - [ ] 实现一键恢复
  - [ ] 测试灾难恢复
- **优先级**：低
- **预计时间**：3小时

## 📅 时间规划

### 第1周：核心功能（20小时）
- 任务1-7：16小时
- 任务8-9：4小时

### 第2周：使用量追踪（11小时）
- 任务10-12：8小时
- 任务13：3小时

### 第3-4周：付费系统（23小时）
- 任务14-16：17小时
- 任务17-18：6小时

### 第5-6周：后端和优化（24小时）
- 任务19-20：16小时
- 任务21-24：8小时

**总计：约78小时**

## ✅ 验收标准

### 阶段一完成标准
- [ ] 用户首次访问必须设置API密钥
- [ ] API密钥验证功能正常
- [ ] 生成图片功能正常
- [ ] 安全头已添加
- [ ] 通过基础安全测试

### 阶段二完成标准
- [ ] 使用量统计准确
- [ ] 每日限制生效
- [ ] 超限提示友好
- [ ] 数据持久化正常

### 阶段三完成标准
- [ ] 支付流程完整
- [ ] 套餐升级成功
- [ ] 用户系统稳定
- [ ] 后端API可用

## 📝 注意事项

1. **测试驱动**：每个功能完成后立即测试
2. **渐进部署**：先部署到测试环境，再上生产
3. **用户反馈**：及时收集并响应用户反馈
4. **安全第一**：所有功能都要考虑安全性
5. **性能监控**：持续关注系统性能指标

## 🚀 快速开始

要立即开始实施，请按以下顺序执行：

1. **克隆项目**：
   ```bash
   git clone <repository-url>
   cd child-name-demo-main
   ```

2. **创建功能分支**：
   ```bash
   git checkout -b feature/user-api-key
   ```

3. **执行任务1-7**（核心功能）

4. **测试并提交**：
   ```bash
   git add .
   git commit -m "feat: 实施用户自备API密钥功能"
   git push origin feature/user-api-key
   ```

5. **创建Pull Request并部署到GitHub Pages**

开始您的商业化改造之旅吧！🎉