<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIå®¢æˆ·ç«¯æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .result {
            background: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .status {
            font-weight: bold;
            padding: 5px;
            margin: 5px 0;
            border-radius: 4px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>Nano Banana API å®¢æˆ·ç«¯æµ‹è¯•</h1>

    <div class="test-section">
        <h2>1. åˆå§‹åŒ–æµ‹è¯•</h2>
        <button onclick="testInitialization()">æµ‹è¯•åˆå§‹åŒ–</button>
        <div id="initResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. APIå¯†é’¥ç®¡ç†æµ‹è¯•</h2>
        <button onclick="testDefaultKey()">æµ‹è¯•é»˜è®¤å¯†é’¥</button>
        <button onclick="testUserKey()">æµ‹è¯•ç”¨æˆ·å¯†é’¥</button>
        <button onclick="testClearUserKey()">æ¸…é™¤ç”¨æˆ·å¯†é’¥</button>
        <button onclick="testKeyPriority()">æµ‹è¯•å¯†é’¥ä¼˜å…ˆçº§</button>
        <div id="keyResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. APIè°ƒç”¨æµ‹è¯•</h2>
        <button onclick="testAPICall()">æµ‹è¯•APIè°ƒç”¨</button>
        <div id="apiResult" class="result"></div>
    </div>

    <!-- åŠ è½½å¿…è¦çš„è„šæœ¬ -->
    <script src="config.js"></script>
    <script src="js/security-utils.js"></script>
    <script src="js/api-client.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let client;
        const resultDivs = {
            init: document.getElementById('initResult'),
            key: document.getElementById('keyResult'),
            api: document.getElementById('apiResult')
        };

        // åˆå§‹åŒ–
        async function init() {
            try {
                // æ¨¡æ‹Ÿå…¨å±€é…ç½®
                window.config = {
                    apiEndpoint: 'https://api.kie.ai/api/v1/jobs/',
                    apiKey: 'sk-test-default-key-123456789'
                };

                // åˆå§‹åŒ–å®‰å…¨å·¥å…·
                if (typeof SecurityUtils !== 'undefined') {
                    window.securityUtils = new SecurityUtils();
                }

                // åˆ›å»ºAPIå®¢æˆ·ç«¯
                client = new NanoBananaClient();
                await client.initialize();

                appendResult('init', 'âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ', 'success');
                appendResult('init', `APIç«¯ç‚¹: ${client.apiEndpoint}`, 'info');
                appendResult('init', `å½“å‰å¯†é’¥æ¥æº: ${client.apiKeySource}`, 'info');
                appendResult('init', `æ˜¯å¦æœ‰å¯†é’¥: ${!!client.apiKey}`, 'info');
            } catch (error) {
                appendResult('init', `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•åˆå§‹åŒ–
        async function testInitialization() {
            await init();
        }

        // æµ‹è¯•é»˜è®¤å¯†é’¥
        async function testDefaultKey() {
            try {
                if (!client) {
                    await init();
                }

                // æ¸…é™¤ç”¨æˆ·å¯†é’¥ï¼Œåªä¿ç•™é»˜è®¤å¯†é’¥
                await client.clearUserApiKey();
                await client.initialize();

                appendResult('key', 'âœ… é»˜è®¤å¯†é’¥æµ‹è¯•:', 'success');
                appendResult('key', `å¯†é’¥æ¥æº: ${client.apiKeySource}`, 'info');
                appendResult('key', `å¯†é’¥å­˜åœ¨: ${!!client.apiKey}`, 'info');
                appendResult('key', `å¯†é’¥å€¼: ${client.apiKey ? client.apiKey.substring(0, 20) + '...' : 'null'}`, 'info');
            } catch (error) {
                appendResult('key', `âŒ é»˜è®¤å¯†é’¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•ç”¨æˆ·å¯†é’¥
        async function testUserKey() {
            try {
                if (!client) {
                    await init();
                }

                const testUserKey = 'sk-test-user-key-987654321';

                // è®¾ç½®ç”¨æˆ·å¯†é’¥
                await client.setUserApiKey(testUserKey);

                appendResult('key', 'âœ… ç”¨æˆ·å¯†é’¥æµ‹è¯•:', 'success');
                appendResult('key', `å¯†é’¥æ¥æº: ${client.apiKeySource}`, 'info');
                appendResult('key', `å¯†é’¥å­˜åœ¨: ${!!client.apiKey}`, 'info');
                appendResult('key', `å¯†é’¥å€¼: ${client.apiKey ? client.apiKey.substring(0, 20) + '...' : 'null'}`, 'info');
            } catch (error) {
                appendResult('key', `âŒ ç”¨æˆ·å¯†é’¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¸…é™¤ç”¨æˆ·å¯†é’¥
        async function testClearUserKey() {
            try {
                if (!client) {
                    await init();
                }

                await client.clearUserApiKey();

                appendResult('key', 'âœ… æ¸…é™¤ç”¨æˆ·å¯†é’¥æˆåŠŸ', 'success');
                appendResult('key', `å¯†é’¥æ¥æº: ${client.apiKeySource}`, 'info');
                appendResult('key', `å¯†é’¥å­˜åœ¨: ${!!client.apiKey}`, 'info');
            } catch (error) {
                appendResult('key', `âŒ æ¸…é™¤ç”¨æˆ·å¯†é’¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å¯†é’¥ä¼˜å…ˆçº§
        async function testKeyPriority() {
            try {
                if (!client) {
                    await init();
                }

                appendResult('key', 'ğŸ”„ æµ‹è¯•å¯†é’¥ä¼˜å…ˆçº§...', 'info');

                // 1. å…ˆè®¾ç½®ç”¨æˆ·å¯†é’¥
                await client.setUserApiKey('sk-user-priority-test');
                appendResult('key', `1. è®¾ç½®ç”¨æˆ·å¯†é’¥å: ${client.apiKeySource}`, 'info');

                // 2. é‡æ–°åˆå§‹åŒ–ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å¯†é’¥
                await client.initialize();
                appendResult('key', `2. é‡æ–°åˆå§‹åŒ–å: ${client.apiKeySource}`, 'info');

                // 3. æ¸…é™¤ç”¨æˆ·å¯†é’¥ï¼Œåº”è¯¥æ¢å¤é»˜è®¤å¯†é’¥
                await client.clearUserApiKey();
                appendResult('key', `3. æ¸…é™¤ç”¨æˆ·å¯†é’¥å: ${client.apiKeySource}`, 'info');

                appendResult('key', 'âœ… å¯†é’¥ä¼˜å…ˆçº§æµ‹è¯•å®Œæˆ', 'success');
            } catch (error) {
                appendResult('key', `âŒ å¯†é’¥ä¼˜å…ˆçº§æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•APIè°ƒç”¨
        async function testAPICall() {
            try {
                if (!client) {
                    await init();
                }

                appendResult('api', 'ğŸ”„ æµ‹è¯•APIè°ƒç”¨ï¼ˆæ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼‰...', 'info');

                // è¿™é‡Œåªæ˜¯æµ‹è¯•æ–¹æ³•è°ƒç”¨ï¼Œä¸å®é™…å‘é€è¯·æ±‚
                // å®é™…è°ƒç”¨éœ€è¦çœŸå®çš„APIå¯†é’¥å’Œæœ‰æ•ˆçš„æç¤ºè¯
                appendResult('api', 'âœ… APIå®¢æˆ·ç«¯æ–¹æ³•å¯ç”¨', 'success');
                appendResult('api', 'â„¹ï¸ æ³¨æ„ï¼šå®é™…APIè°ƒç”¨éœ€è¦æœ‰æ•ˆçš„APIå¯†é’¥', 'info');
                appendResult('api', `â„¹ï¸ å½“å‰å¯†é’¥æ¥æº: ${client.apiKeySource}`, 'info');
                appendResult('api', `â„¹ï¸ createTaskæ–¹æ³•å­˜åœ¨: ${typeof client.createTask === 'function'}`, 'info');
                appendResult('api', `â„¹ï¸ queryTaskStatusæ–¹æ³•å­˜åœ¨: ${typeof client.queryTaskStatus === 'function'}`, 'info');
            } catch (error) {
                appendResult('api', `âŒ APIè°ƒç”¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ ç»“æœ
        function appendResult(type, message, status = 'info') {
            const div = resultDivs[type];
            if (div) {
                const statusDiv = document.createElement('div');
                statusDiv.className = `status ${status}`;
                statusDiv.textContent = message;
                div.appendChild(statusDiv);
                div.scrollTop = div.scrollHeight;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            appendResult('init', 'ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡æµ‹è¯•...', 'info');
        });
    </script>
</body>
</html>