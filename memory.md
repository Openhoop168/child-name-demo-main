# 儿童识字小报生成器 - 项目记忆文件

## 📋 项目概述

**项目名称**：儿童识字小报生成器
**目标用户**：5-9岁儿童的家长和教育工作者
**核心功能**：通过AI技术生成个性化的识字学习小报图片
**技术栈**：HTML5 + CSS3 + Vanilla JavaScript + Nano Banana Pro API
**部署方式**：GitHub Pages

## 🎯 项目目标

### 当前状态
- ✅ 基础功能完整：4步式工作流（输入→预览→生成→下载）
- ✅ 内置6个主题场景：超市、医院、公园、学校、家庭、动物园
- ✅ 完整的AI集成：Nano Banana Pro API调用和任务轮询
- ❌ **问题**：使用硬编码API密钥，所有成本由项目方承担

### 商业化目标
1. **成本转嫁**：让用户使用自己的API密钥，实现零成本运营
2. **使用量控制**：实施免费额度限制，防止滥用
3. **付费转化**：为未来的付费套餐系统打下基础
4. **可持续发展**：建立可长期运营的商业模式

## 🏗️ 技术架构详解

### 文件结构
```
child-name-demo-main/
├── index.html                 # 主页面 - 4步式界面
├── css/style.css              # 样式文件 - 响应式设计
├── js/
│   ├── config.js              # 配置文件 - 包含硬编码API密钥 ⚠️
│   ├── app.js                 # 主应用 - ChildrenLiteracyApp类
│   ├── api-client.js          # API客户端 - NanoBananaClient类
│   ├── security-utils.js      # 安全工具 - SecurityUtils类，XOR加密
│   ├── storage-manager.js     # 存储管理 - StorageManager类
│   ├── vocabulary-manager.js  # 词汇管理 - VocabularyManager类
│   └── prompt-generator.js    # 提示词生成 - PromptGenerator类
├── data/vocabulary.json       # 词汇库 - 6个主题的词汇数据
└── build.js                   # 构建脚本 - 环境变量处理
```

### 核心类和功能

#### 1. ChildrenLiteracyApp (js/app.js)
**职责**：主应用控制器，管理整个用户流程
- **初始化流程**：配置验证 → 模块初始化 → DOM绑定
- **步骤管理**：4步工作流控制
- **API密钥管理**：当前支持编辑/保存硬编码密钥
- **任务轮询**：实时状态更新，支持中断
- **历史记录**：最多100条生成记录

**关键方法**：
```javascript
initialize()          // 应用初始化
generateImage()       // 触发图片生成
saveApiKey()          // 保存API密钥（当前保存硬编码密钥）
updateAPIConfigStatus() // 更新API配置状态显示
```

#### 2. NanoBananaClient (js/api-client.js)
**职责**：Nano Banana Pro API的封装
- **配置管理**：从config.js加载API设置
- **任务创建**：构建API参数，调用createTask接口
- **状态轮询**：pollTaskUntilComplete，最多60次×3秒
- **密钥管理**：支持加密保存/加载API密钥

**API调用流程**：
```
构建参数 → createTask → 获取taskId → 轮询状态 → 获取结果URL
```

#### 3. SecurityUtils (js/security-utils.js)
**职责**：数据安全和加密
- **XOR加密**：32位随机密钥异或加密
- **Base64编码**：Unicode安全的Base64处理
- **密钥验证**：长度（20-200字符）和格式验证
- **安全存储**：`secure_`前缀的localStorage存储

**加密流程**：
```
数据 → JSON.stringify → XOR加密 → Base64编码 → localStorage
```

#### 4. StorageManager (js/storage-manager.js)
**职责**：数据持久化管理
- **API配置**：nano_banana_api_key, nano_banana_api_endpoint
- **用户数据**：生成历史、用户偏好、自定义词汇
- **缓存管理**：词汇缓存、提示词缓存（带TTL）
- **数据限制**：历史记录最多100条

## 🔑 API密钥现状分析

### 当前实现（问题）
```javascript
// config.js - 硬编码的API密钥 ⚠️
window.APP_CONFIG = {
    nanoBanana: {
        apiKey: "2e171c664da19baffdf89e06c29df6d2",  // 硬编码！
        apiEndpoint: "https://api.kie.ai/api/v1/jobs/",
        // ...
    }
};
```

### API调用流程
1. **初始化**：从config.js加载硬编码密钥
2. **使用**：所有用户共享同一个密钥
3. **成本**：所有生成费用由项目方承担
4. **风险**：密钥暴露在代码中，存在安全风险

### 需要改造的部分
1. **移除硬编码密钥**：config.js不再包含默认密钥
2. **用户密钥管理**：首次使用强制设置个人API密钥
3. **验证流程**：密钥格式验证 + 有效性验证
4. **使用量追踪**：为后续限制功能做准备

## 📊 商业化改造方案

### 阶段一：用户自备API密钥（立即实施）

#### 核心改动
1. **修改应用初始化逻辑** (js/app.js)
   - 添加checkUserApiKey()方法
   - 实现showApiKeySetupModal()界面
   - 强制用户首次使用设置密钥

2. **更新API客户端** (js/api-client.js)
   - 移除默认密钥加载
   - 添加setUserApiKey()方法
   - 使用用户提供的密钥调用API

3. **创建密钥设置界面** (css/style.css)
   - .api-key-setup样式
   - 步骤化引导界面
   - 安全提示和输入验证

4. **更新配置模板** (config.template.js)
   - 移除默认API密钥
   - 添加requireUserApiKey: true配置
   - 添加使用量追踪配置

#### 用户流程
```
首次访问 → 密钥设置引导 → 获取Nano Banana账号 → 输入密钥 → 验证成功 → 正常使用
```

### 阶段二：使用量追踪（1-2周后）

#### 新增功能
1. **UsageTracker类** (js/usage-tracker.js)
   - 每日免费额度限制（50次）
   - 使用量统计和展示
   - 接近限制提醒

2. **集成到主应用**
   - 生成前检查额度
   - 生成后追踪使用量
   - 超限提示和升级引导

### 阶段三：付费套餐系统（1-2个月后）

#### 套餐设计
| 套餐 | 生成次数 | 价格 | 特点 |
|------|---------|------|------|
| 免费版 | 5次/天 | 免费 | 基础功能 |
| 基础版 | 100次/月 | ¥29 | 无水印 |
| 专业版 | 500次/月 | ¥99 | 4K高清 |
| 教育版 | 无限 | ¥299 | 团队功能 |

#### 支付集成
- 支付宝/微信支付SDK
- 套餐选择和管理
- 支付状态同步

## 🔒 安全和隐私考虑

### 现有安全措施
- ✅ **XOR加密存储**：API密钥本地加密保存
- ✅ **输入验证**：长度、格式检查
- ✅ **XSS防护**：HTML转义处理
- ✅ **本地存储**：数据不离开用户设备

### 改造后安全措施
- ✅ **用户密钥隔离**：每用户独立密钥，无共享风险
- ✅ **密钥验证**：格式验证 + API有效性验证
- ✅ **安全提示**：明确告知密钥仅本地存储
- ✅ **使用限制**：防止恶意滥用

## 📝 关键配置和依赖

### Nano Banana Pro API
- **端点**：https://api.kie.ai/api/v1/jobs/
- **认证**：Bearer Token（用户API密钥）
- **任务创建**：POST /createTask
- **状态查询**：GET /queryTaskStatus/{taskId}
- **参数**：4K分辨率、3:4比例、PNG格式

### 词汇库结构
```json
{
  "themes": {
    "超市": {
      "core": ["收银员", "货架", "推车", ...],
      "common": ["商品", "价格标签", "购物篮", ...],
      "environment": ["入口", "出口", "促销区", ...]
    }
  }
}
```

### 提示词模板
5部分结构：标题区 → 主体画面 → 必画物体 → 识字标注 → 画风参数

## 🚀 部署和维护

### 当前部署
- **平台**：GitHub Pages
- **域名**：自动生成的github.io域名
- **HTTPS**：自动支持
- **CDN**：GitHub全球CDN

### 构建流程
```bash
# 1. 环境变量配置
cp .env.example .env.local
# 编辑 .env.local 设置必要的变量

# 2. 构建配置文件
node build.js

# 3. 部署到GitHub Pages
git add .
git commit -m "update config"
git push origin main
```

### 监控指标
- API密钥设置成功率
- 图片生成成功率
- 用户使用频率
- 错误日志分析

## 🎯 用户体验设计

### 当前用户流程
1. **输入信息**：主题 + 标题
2. **预览提示词**：查看生成的AI提示词和词汇
3. **生成图片**：30-60秒生成时间
4. **下载保存**：PNG格式，A4比例

### 改造后用户流程
1. **首次访问**：API密钥设置（一次性）
2. **正常使用**：原有4步流程保持不变
3. **使用提醒**：接近免费额度时的提醒
4. **付费引导**：超限时的套餐升级引导

## 📋 实施检查清单

### 阶段一：用户密钥系统
- [ ] 修改js/app.js - 添加密钥检查和设置逻辑
- [ ] 更新js/api-client.js - 移除默认密钥，支持用户密钥
- [ ] 创建css/style.css - 密钥设置界面样式
- [ ] 更新config.template.js - 移除硬编码密钥
- [ ] 增强index.html - 添加安全头标签
- [ ] 测试完整流程 - 从首次访问到图片生成

### 阶段二：使用量管理
- [ ] 创建js/usage-tracker.js - 使用量追踪模块
- [ ] 集成到js/app.js - 在生成流程中加入额度检查
- [ ] 添加UI提示 - 使用量显示和提醒
- [ ] 测试限制功能 - 确保额度正确生效

### 阶段三：付费系统
- [ ] 创建js/payment-manager.js - 支付管理模块
- [ ] 设计套餐UI - 套餐选择和购买界面
- [ ] 集成支付SDK - 支付宝/微信支付
- [ ] 实现用户系统 - 注册、登录、订单管理

## 🔄 版本历史

### v1.0.0 (当前)
- 基础识字小报生成功能
- 硬编码API密钥（需要改造）
- 完整的4步工作流
- 6个内置主题场景

### v1.1.0 (计划)
- 用户自备API密钥
- API密钥验证流程
- 安全增强措施
- 使用量追踪基础

### v1.2.0 (计划)
- 免费额度限制
- 使用量统计展示
- 付费套餐界面
- 支付集成

### v1.3.0 (计划)
- 完整付费系统
- 用户账户管理
- 高级功能解锁
- 数据分析后台

## 📈 任务完成情况跟踪

### 完成规则
**根据任务完成情况，每完成一个任务，标记为✅**

- ✅ **任务1**：修改应用初始化逻辑 - 已完成（2025-12-13）
- ✅ **任务2**：实现API密钥管理功能 - 已完成（2025-12-13）
- ✅ **任务3**：修改API客户端 - 已完成（2025-12-13）

### 当前状态
- **第一阶段进度**：3/3 核心任务已完成 ✅✅✅
- **总体进度**：3/24 任务已完成（12.5%）
- **下一步**：继续执行任务4（创建API密钥设置界面）

### 已实现的关键功能
1. **智能密钥管理系统**
   - 支持用户密钥和默认密钥的自动切换
   - 优先使用用户密钥，提升用户自主性
   - 保留默认密钥，确保新用户体验

2. **完整的密钥管理界面**
   - 用户友好的API密钥设置模态框
   - 密钥来源状态实时显示
   - 一键切换用户密钥和默认密钥

3. **用量追踪基础**
   - API调用来源追踪（user/default）
   - 为后续付费模式提供数据基础
   - 支持使用量统计和分析

---

**重要提醒**：此文件包含项目的核心技术和商业信息，需要持续更新以反映项目的最新状态。在实施任何改动时，请参考此文件以确保符合项目整体规划。

**最后更新**：2025-12-13
**维护人员**：项目开发团队