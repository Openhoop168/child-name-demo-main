<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>儿童识字小报生成器</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- 安全头配置 -->
    <meta http-equiv="Content-Security-Policy"
          content="default-src 'self';
                   script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                   style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                   img-src 'self' data: blob: https:;
                   font-src 'self' https://cdnjs.cloudflare.com;
                   connect-src 'self' https://api.kie.ai;
                   media-src 'self';
                   object-src 'none';
                   base-uri 'self';
                   form-action 'self';">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta name="referrer" content="strict-origin-when-cross-origin">
</head>
<body>
    <div class="container">
        <!-- 头部 -->
        <header class="header">
            <div class="header-left">
                <h1><i class="fas fa-book-open"></i> 儿童识字小报生成器</h1>
                <p class="subtitle">专为5-9岁儿童设计的智能识字工具</p>
            </div>
            <div class="header-right">
                <div id="usage-display" class="usage-display">
                    <!-- 使用量显示将在这里动态生成 -->
                </div>
            </div>
        </header>

        <!-- 主要内容区域 -->
        <main class="main-content">
            <!-- 步骤指示器 -->
            <div class="step-indicator">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">输入信息</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">预览提示词</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">生成图片</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">下载保存</div>
                </div>
            </div>

            <!-- 步骤1：输入信息 -->
            <div class="step-content active" id="step1">
                <div class="card">
                    <h2><i class="fas fa-edit"></i> 创建识字小报</h2>

                    <form id="inputForm" class="form">
                        <div class="form-group">
                            <label for="theme">
                                <i class="fas fa-palette"></i>
                                主题/场景
                            </label>
                            <input
                                type="text"
                                id="theme"
                                name="theme"
                                placeholder="例如：超市、医院、公园、学校..."
                                required
                                autocomplete="off"
                            >
                            <small class="help-text">请输入一个适合儿童学习的场景主题</small>
                        </div>

                        <div class="form-group">
                            <label for="title">
                                <i class="fas fa-heading"></i>
                                小报标题
                            </label>
                            <input
                                type="text"
                                id="title"
                                name="title"
                                placeholder="例如：《走进超市》《快乐医院》"
                                required
                                autocomplete="off"
                            >
                            <small class="help-text">为识字小报起一个吸引人的标题</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-arrow-right"></i>
                                下一步：预览提示词
                            </button>
                        </div>
                    </form>

                    <!-- 快速示例 -->
                    <div class="examples">
                        <h3><i class="fas fa-lightbulb"></i> 快速示例</h3>
                        <div class="example-cards">
                            <div class="example-card" data-theme="超市" data-title="《走进超市》">
                                <div class="example-icon">🛒</div>
                                <div class="example-text">超市购物</div>
                            </div>
                            <div class="example-card" data-theme="医院" data-title="《快乐医院》">
                                <div class="example-icon">🏥</div>
                                <div class="example-text">医院就诊</div>
                            </div>
                            <div class="example-card" data-theme="公园" data-title="《美丽公园》">
                                <div class="example-icon">🌳</div>
                                <div class="example-text">公园游玩</div>
                            </div>
                            <div class="example-card" data-theme="学校" data-title="《开心上学》">
                                <div class="example-icon">🏫</div>
                                <div class="example-text">学校生活</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 步骤2：预览提示词 -->
            <div class="step-content" id="step2">
                <div class="card">
                    <h2><i class="fas fa-eye"></i> 提示词预览</h2>

                    <div class="prompt-preview">
                        <div class="prompt-header">
                            <h3>生成的AI绘图提示词</h3>
                            <div class="prompt-actions">
                                <button id="copyPrompt" class="btn btn-secondary">
                                    <i class="fas fa-copy"></i> 复制
                                </button>
                                <button id="editPrompt" class="btn btn-secondary">
                                    <i class="fas fa-edit"></i> 编辑
                                </button>
                            </div>
                        </div>

                        <div class="prompt-content">
                            <textarea id="promptText" readonly></textarea>
                        </div>

                        <div class="vocabulary-list">
                            <h4><i class="fas fa-list"></i> 包含的词汇</h4>
                            <div id="vocabularyDisplay" class="vocabulary-grid"></div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button id="backToStep1" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> 返回修改
                        </button>
                        <button id="generateImage" class="btn btn-primary">
                            <i class="fas fa-magic"></i> 生成图片
                        </button>
                    </div>
                </div>
            </div>

            <!-- 步骤3：生成图片 -->
            <div class="step-content" id="step3">
                <div class="card">
                    <h2><i class="fas fa-image"></i> 正在生成图片</h2>

                    <div class="generation-progress">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                            <div class="progress-text">准备中...</div>
                        </div>

                        <div class="generation-status">
                            <div class="status-icon">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                            <div class="status-text">正在调用AI生成服务...</div>
                        </div>
                    </div>

                    <div class="api-logs" id="apiLogs">
                        <h4><i class="fas fa-terminal"></i> 生成日志</h4>
                        <div class="log-container"></div>
                    </div>
                </div>
            </div>

            <!-- 步骤4：结果展示 -->
            <div class="step-content" id="step4">
                <div class="card">
                    <h2><i class="fas fa-check-circle"></i> 生成完成</h2>

                    <div class="result-container">
                        <div class="image-preview">
                            <img id="generatedImage" src="" alt="生成的识字小报">
                            <div class="image-actions">
                                <button id="downloadImage" class="btn btn-success">
                                    <i class="fas fa-download"></i> 下载图片
                                </button>
                                <button id="shareImage" class="btn btn-secondary">
                                    <i class="fas fa-share-alt"></i> 分享
                                </button>
                            </div>
                        </div>

                        <div class="result-info">
                            <h3><i class="fas fa-info-circle"></i> 生成信息</h3>
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>主题：</label>
                                    <span id="resultTheme"></span>
                                </div>
                                <div class="info-item">
                                    <label>标题：</label>
                                    <span id="resultTitle"></span>
                                </div>
                                <div class="info-item">
                                    <label>生成时间：</label>
                                    <span id="resultTime"></span>
                                </div>
                                <div class="info-item">
                                    <label>图片尺寸：</label>
                                    <span id="resultSize"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button id="createNew" class="btn btn-primary">
                            <i class="fas fa-plus"></i> 创建新的小报
                        </button>
                        <button id="regenerate" class="btn btn-secondary">
                            <i class="fas fa-redo"></i> 重新生成
                        </button>
                    </div>
                </div>
            </div>

            <!-- 生成历史记录 -->
            <div class="generation-history">
                <div class="card">
                    <h3><i class="fas fa-history"></i> 生成历史</h3>
                    <div class="history-controls">
                        <button id="clearHistory" class="btn btn-secondary">
                            <i class="fas fa-trash"></i> 清空历史
                        </button>
                        <div class="history-count">
                            共 <span id="historyCount">0</span> 条记录
                        </div>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="empty-history">
                            <i class="fas fa-inbox"></i>
                            <p>暂无生成历史</p>
                            <small>生成的小报将保存在这里</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API配置区域 -->
            <div class="api-config">
                <div class="card">
                    <h3><i class="fas fa-cog"></i> API配置</h3>
                    <div class="config-form">
                        <div class="form-group">
                            <label for="apiKey">API密钥</label>
                            <div class="input-group">
                                <input
                                    type="password"
                                    id="apiKey"
                                    placeholder="请输入Nano Banana Pro API密钥"
                                    autocomplete="off"
                                    readonly
                                >
                                <button id="toggleApiKey" class="btn btn-icon">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button id="editApiKey" class="btn btn-secondary" style="display: none;">
                                    <i class="fas fa-edit"></i> 修改
                                </button>
                                <button id="saveApiKey" class="btn btn-secondary">
                                    <i class="fas fa-save"></i> 保存
                                </button>
                            </div>
                            <div class="config-status" id="apiKeyStatus">
                                <i class="fas fa-check-circle" style="color: #96CEB4;"></i>
                                <span>API密钥已配置</span>
                            </div>
                            <div class="config-actions">
                                <button id="setUserApiKey" class="btn btn-outline btn-sm">
                                    <i class="fas fa-user-plus"></i> 使用自己的API密钥
                                </button>
                                <button id="clearUserApiKey" class="btn btn-outline btn-sm" style="display: none;">
                                    <i class="fas fa-user-minus"></i> 恢复默认密钥
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="apiEndpoint">API端点</label>
                            <input
                                type="text"
                                id="apiEndpoint"
                                value="https://api.kie.ai/api/v1/jobs/"
                                readonly
                            >
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 页脚 -->
        <footer class="footer">
            <p>&copy; 2024 儿童识字小报生成器 | 使用Nano Banana Pro API</p>
        </footer>
    </div>

    <!-- 模态框：加载提示 -->
    <div class="modal" id="loadingModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div class="modal-text">处理中，请稍候...</div>
        </div>
    </div>

    <!-- 模态框：消息提示 -->
    <div class="modal" id="messageModal">
        <div class="modal-content">
            <div class="modal-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="modal-text" id="messageText"></div>
            <button class="btn btn-primary modal-close">确定</button>
        </div>
    </div>

    <!-- 配置文件（必须在其他脚本之前加载） -->
    <script src="js/config.js"></script>

    <!-- JavaScript文件 -->
    <script src="js/vocabulary-manager.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/usage-tracker.js"></script>
    <script src="js/security-utils.js"></script>
    <script src="js/prompt-generator.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/app.js"></script>
</body>
</html>